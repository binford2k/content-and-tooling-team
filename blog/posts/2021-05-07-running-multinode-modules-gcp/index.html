<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/content-and-tooling-team/favicons/favicon.ico><link rel=apple-touch-icon href=/content-and-tooling-team/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/content-and-tooling-team/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/content-and-tooling-team/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/content-and-tooling-team/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/content-and-tooling-team/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/content-and-tooling-team/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/content-and-tooling-team/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/content-and-tooling-team/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/content-and-tooling-team/favicons/android-192x192.png sizes=192x192><title>Run multi-node module tests with cloud continuous integration (CI) in Google Cloud Platform (GCP) | Content and Tooling</title><meta name=description content="Multi-node modules are modules which use multiple nodes to run integration tests. Integration testing is where you set up multiple Virtual Machines …"><meta property="og:title" content="Run multi-node module tests with cloud continuous integration (CI) in Google Cloud Platform (GCP)"><meta property="og:description" content="Multi-node modules are modules which use multiple nodes to run integration tests. Integration testing is where you set up multiple Virtual Machines (VM) or containers, and test interactions between them. For example, this could be:
 Installing Puppet Enterprise (PE) and multiple Puppet agents. Setting up an NTP server and registering NTP clients. Installing open source Puppet Server and multiple Puppet agents.  The order you perform integration tests is important, and you need to be able to run a test on an individual system."><meta property="og:type" content="article"><meta property="og:url" content="https://puppetlabs.github.io/content-and-tooling-team/blog/posts/2021-05-07-running-multinode-modules-gcp/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-05-07T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-24T14:02:25+00:00"><meta itemprop=name content="Run multi-node module tests with cloud continuous integration (CI) in Google Cloud Platform (GCP)"><meta itemprop=description content="Multi-node modules are modules which use multiple nodes to run integration tests. Integration testing is where you set up multiple Virtual Machines (VM) or containers, and test interactions between them. For example, this could be:
 Installing Puppet Enterprise (PE) and multiple Puppet agents. Setting up an NTP server and registering NTP clients. Installing open source Puppet Server and multiple Puppet agents.  The order you perform integration tests is important, and you need to be able to run a test on an individual system."><meta itemprop=datePublished content="2021-05-07T00:00:00+00:00"><meta itemprop=dateModified content="2022-03-24T14:02:25+00:00"><meta itemprop=wordCount content="1009"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Run multi-node module tests with cloud continuous integration (CI) in Google Cloud Platform (GCP)"><meta name=twitter:description content="Multi-node modules are modules which use multiple nodes to run integration tests. Integration testing is where you set up multiple Virtual Machines (VM) or containers, and test interactions between them. For example, this could be:
 Installing Puppet Enterprise (PE) and multiple Puppet agents. Setting up an NTP server and registering NTP clients. Installing open source Puppet Server and multiple Puppet agents.  The order you perform integration tests is important, and you need to be able to run a test on an individual system."><link rel=preload href=/content-and-tooling-team/scss/main.min.708b8eb536aa0debb8b80098b7381547f2d71482d991ac4d1a493e8e52687dc0.css as=style><link href=/content-and-tooling-team/scss/main.min.708b8eb536aa0debb8b80098b7381547f2d71482d991ac4d1a493e8e52687dc0.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-00000000-0','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/content-and-tooling-team/><span class=navbar-logo><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" id="svg3713" width="30" height="30" viewBox="0 0 30 30.000001" sodipodi:docname="puppet-logo-amber.svg" inkscape:version="0.92.4 (5da689c313, 2019-01-14)"><defs id="defs3717"/><sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="2544" inkscape:window-height="1221" id="namedview3715" showgrid="false" inkscape:zoom="9.1657311" inkscape:cx="95.465911" inkscape:cy="-12.96395" inkscape:window-x="-8" inkscape:window-y="-8" inkscape:window-maximized="1" inkscape:current-layer="g3721" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0"/><g id="g3721" inkscape:groupmode="layer" inkscape:label="Puppet-Logo-Mark-Amber" transform="matrix(1.3333333,0,0,-1.3333333,-30.985333,60.985317)"><path d="m32.416539 25.664063h-2.164731v2.16473h2.164731zm-2.164731 17.420479h2.164731v-2.16473h-2.164731zm11.960601-5.463051h-4.96675l.0015.0015-2.66579 2.66579v4.96057h-6.494368v-6.494377h4.966749l2.662712-2.662711.0016.0015v-3.439051l-.0032.0032-2.664205-2.664297v0H28.087v-6.494377h6.494377v4.963577.0l2.664204 2.664297h4.966843z" style="fill:#ffae1a;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:.09330733" id="path3723" inkscape:connector-curvature="0"/></g></svg></span><span class="text-uppercase font-weight-bold">Content and Tooling</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/content-and-tooling-team/pct/><span>PCT</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/content-and-tooling-team/prm/><span>PRM</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/content-and-tooling-team/blog/><span class=active>Blog</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-content-and-tooling-teamblog-li><a href=/content-and-tooling-team/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-content-and-tooling-teamblog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-content-and-tooling-teamblogposts-li><a href=/content-and-tooling-team/blog/posts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-content-and-tooling-teamblogposts><span>Posts</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogpostsprm-initial-release-li><a href=/content-and-tooling-team/blog/posts/prm-initial-release/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogpostsprm-initial-release><span>Puppet Runtime Manager 0.1.0 Release 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogposts2021-10-20-fond-farewell-li><a href=/content-and-tooling-team/blog/posts/2021-10-20-fond-farewell/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogposts2021-10-20-fond-farewell><span>A Fond Farewell For Now to Community Day & Norman</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogpostsfuture-of-pdk-li><a href=/content-and-tooling-team/blog/posts/future-of-pdk/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogpostsfuture-of-pdk><span>The future of the Puppet Developer Kit (PDK)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogposts2021-06-04-pct-early-release-li><a href=/content-and-tooling-team/blog/posts/2021-06-04-pct-early-release/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogposts2021-06-04-pct-early-release><span>Puppet Content Templates 0.1.0 🚀</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-content-and-tooling-teamblogposts2021-05-07-running-multinode-modules-gcp-li><a href=/content-and-tooling-team/blog/posts/2021-05-07-running-multinode-modules-gcp/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogposts2021-05-07-running-multinode-modules-gcp><span class=td-sidebar-nav-active-item>Run multi-node module tests with cloud continuous integration (CI) in Google Cloud Platform (GCP)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child"><a href=https://puppetlabs.github.io/content-and-tooling-team/blog/posts/>View More</a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-content-and-tooling-teamblogupdates-li><a href=/content-and-tooling-team/blog/updates/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-content-and-tooling-teamblogupdates><span>Updates</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogupdates2021-10-11-status-update-li><a href=/content-and-tooling-team/blog/updates/2021-10-11-status-update/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogupdates2021-10-11-status-update><span>2021-10-11: IAC & DevX Team Status Update</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogupdates2021-10-04-status-update-li><a href=/content-and-tooling-team/blog/updates/2021-10-04-status-update/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogupdates2021-10-04-status-update><span>2021-10-04: IAC & DevX Team Status Update</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogupdates2021-09-20-status-update-li><a href=/content-and-tooling-team/blog/updates/2021-09-20-status-update/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogupdates2021-09-20-status-update><span>2021-09-20: IAC & DevX Team Status Update</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogupdates2021-09-13-status-update-li><a href=/content-and-tooling-team/blog/updates/2021-09-13-status-update/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogupdates2021-09-13-status-update><span>2021-09-13: IAC & DevX Team Status Update</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-content-and-tooling-teamblogupdates2021-09-06-status-update-li><a href=/content-and-tooling-team/blog/updates/2021-09-06-status-update/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-content-and-tooling-teamblogupdates2021-09-06-status-update><span>2021-09-06: IAC & DevX Team Status Update</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child"><a href=https://puppetlabs.github.io/content-and-tooling-team/blog/updates/>View More</a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/puppetlabs/content-and-tooling-team/edit/main/content/en/blog/posts/2021-05-07-running-multinode-modules-gcp.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/puppetlabs/content-and-tooling-team/new/main/content/en/blog/posts/2021-05-07-running-multinode-modules-gcp.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href=https://github.com/puppetlabs/content-and-tooling-team/issues/new/choose target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/puppetlabs/content-and-tooling-team/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a href=https://github.com/puppetlabs/content-and-tooling-team/discussions/new target=_blank><i class="fas fa-comments fa-fw"></i> Create new discussion topic</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#provision-a-node>Provision a node</a></li><li><a href=#set-up-a-multi-node-environment-for-testing>Set up a multi-node environment for testing</a></li><li><a href=#run-a-test>Run a test</a></li><li><a href=#teardown-the-machine>Teardown the machine</a><ul><li><a href=#multi-node-testing-examples>Multi-node testing examples</a></li></ul></li></ul></nav></div><script>function revealTags(a){console.log(a);var b=document.getElementsByClassName("hidden");for(let c of b)c.id.split("--")[0]==a&&(c.style.display="inline-block");document.getElementById(a).remove()}</script><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://puppetlabs.github.io/content-and-tooling-team/categories/updates/ data-taxonomy-term=updates><span class=taxonomy-label>updates</span><span class=taxonomy-count>82</span></a></li><li><a class=taxonomy-term href=https://puppetlabs.github.io/content-and-tooling-team/categories/content/ data-taxonomy-term=content><span class=taxonomy-label>content</span><span class=taxonomy-count>8</span></a></li><li><a class=taxonomy-term href=https://puppetlabs.github.io/content-and-tooling-team/categories/tooling/ data-taxonomy-term=tooling><span class=taxonomy-label>tooling</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://puppetlabs.github.io/content-and-tooling-team/categories/team/ data-taxonomy-term=team><span class=taxonomy-label>team</span><span class=taxonomy-count>4</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>Run multi-node module tests with cloud continuous integration (CI) in Google Cloud Platform (GCP)</h1><div class="td-byline mb-4">By <b>sheenaajay</b> |
<time datetime=2021-05-07 class=text-muted>Friday, May 07, 2021</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://puppetlabs.github.io/content-and-tooling-team/categories/tooling/ data-taxonomy-term=tooling><span class=taxonomy-label>tooling</span></a></li></ul></div></header><p>Multi-node modules are modules which use multiple nodes to run integration tests. Integration testing is where you set up multiple Virtual Machines (VM) or containers, and test interactions between them. For example, this could be:</p><ul><li>Installing Puppet Enterprise (PE) and multiple Puppet agents.</li><li>Setting up an NTP server and registering NTP clients.</li><li>Installing open source Puppet Server and multiple Puppet agents.</li></ul><p>The order you perform integration tests is important, and you need to be able to run a test on an individual system.</p><p>Running multi-node modules in GCP involves the following steps:</p><ul><li>Provision a node using a Bolt task.</li><li>Set up a multi-node environment for testing using a Bolt task or plan.</li><li>Run a test - you can use existing serverspec or Litmus helpers to set up any dependencies required by the module.</li><li>Teardown the machine using a provision task.</li></ul><p>This guide walks you through each step, and then provides examples of how your code would look in different environments.</p><h2 id=provision-a-node>Provision a node</h2><p>You can use Litmus and a Bolt task to provision a VM or a container. The provision module&rsquo;s <a href=https://github.com/puppetlabs/provision/blob/main/tasks>available tasks</a> spin up the test environment. When run, it creates a <code>litmus_inventory.yaml</code> file that allows <a href=https://github.com/puppetlabs/bolt>Bolt</a> and <a href=https://serverspec.org/>serverspec</a> to communicate with that VM.</p><p>Running tasks in the provision module allows you to add arbitrary key/pair values to the Bolt inventory file. The Bolt variables allows you to have multiple labels associated with a single machine. For example:</p><p><img src=/content-and-tooling-team/assets/2021-05-07-running-multinode-modules-gcp/inventory_role.png alt="Showing role info in litmus_inventory.yaml file">
<a href=https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/plans/provision_machines.pp>Example_websphere_provision_plan</a></p><h2 id=set-up-a-multi-node-environment-for-testing>Set up a multi-node environment for testing</h2><p>To step up Litmus for your acceptance tests, you need to:</p><ul><li>Install a Puppet agent — you can do this using a Bolt <a href=https://github.com/puppetlabs/puppetlabs-puppet_agent/tree/main/tasks>task</a>.</li><li>Install a module — use a rake task that uses Puppet Development Kit (PDK) to build the module for testing, and install it on the target VM.</li><li>Install <code>spec/spec_helper_acceptance_local.rb</code> — this may require extra setup to test a module. You can use <a href=https://github.com/puppetlabs/puppetlabs-apache/blob/main/spec/spec_helper_acceptance_local.rb>puppetlabs/puppetlabs-apache</a>.</li></ul><p>To set up integration testing, use a Bolt plan and inventory variable to add labels. You can then run Puppet code against a specific system. You can use <a href=https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/plans/pe_server_setup.pp>puppetlabs-websphere_application_server</a></p><p>An example provision plan looks like:</p><pre><code>plan websphere_application_server::provision_machines(
  Optional[String] $using = 'abs',
  Optional[String] $image = 'centos-7-x86_64'
) {
  # provision machines, set roles
  ['server', 'appserver', 'dmgr', 'ihs'].each |$role| {
    run_task(&quot;provision::${using}&quot;, 'localhost', action =&gt; 'provision', platform =&gt; $image, vars =&gt; &quot;role: ${role}&quot;)
  }
}
</code></pre><p>You can use <code>spec/spec_helper_acceptance_local.rb</code> if you need to test a module — <a href=https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/spec/spec_helper_acceptance_local.rb>puppetlabs-websphere_application_server</a></p><h2 id=run-a-test>Run a test</h2><p>To identify which tests to run in an integeration environment, you can use rspec labelling and rake tasks.</p><p>You can label tests using rspec labeling — tag the test as an integration and keep everything else can stay the same. For example:</p><pre><code>describe 'Install the websphere dmgr', :integration do
  before(:all) do
    @agent = WebSphereHelper.dmgr_host
    WebSphereInstance.install(@agent)
    WebSphereDmgr.install(@agent)
  end

  it 'is installed' do
    expect(WebSphereHelper.remote_file_exists(@agent, WebSphereConstants.dmgr_status))
    expect(WebSphereHelper.remote_file_exists(@agent, WebSphereConstants.ws_admin))
  end
end
</code></pre><p>To run a rake task, add to the Rakefile of the module. For example:</p><pre><code>require 'rspec/core/rake_task'
namespace :websphere_application_server do
  RSpec::Core::RakeTask.new(:integration) do |t|
    t.pattern = 'spec/acceptance/**{,/*/**}/*_spec.rb'
    t.rspec_opts = &quot;--tag integration&quot;
  end
end
</code></pre><p>To target a test at a specific VM or container, you can use helper methods. You need to do this if you are using serverspec or Litmus.</p><p>The examples below show how to filter to get either a single VM or container, or how to retrieve multiple targets.
<a href=https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/spec/spec_helper_acceptance_local.rb>puppetlabs-websphere_application_server</a></p><p><a href=https://github.com/puppetlabs/puppetlabs-kubernetes/blob/main/spec/spec_helper_acceptance_local.rb>puppetlabs-kubernetes</a></p><p>To identify a target node, the code would look like:</p><pre><code>      context 'application deployment' do
        before(:all) { change_target_host('controller') }
        after(:all) { reset_target_host }
        it 'can deploy an application into a namespace and expose it' do
          run_shell('KUBECONFIG=/etc/kubernetes/admin.conf kubectl create -f /tmp/nginx.yml') do |r|
            expect(r.stdout).to match(/my-nginx created\nservice\/my-nginx created\n/)
          end
        end
</code></pre><p>To only run on tests labelled as ‘integration’, use the following command:</p><p><code>bundle exec rake websphere_application_server:integration</code></p><h2 id=teardown-the-machine>Teardown the machine</h2><p>To teardown all the provisioned machines, use the following provision task:</p><p><code>bundle exec rake litmus:tear_down</code></p><h3 id=multi-node-testing-examples>Multi-node testing examples</h3><p><em><strong>Multiple Puppet agents</strong></em></p><p>A setup where you have multiple Puppet agents, with a module installed and tests run.</p><p>Commands</p><pre><code>bundle install --path .bundle/gems/ --jobs 4
bundle exec rake spec_prep
bundle exec bolt --modulepath spec/fixtures/modules plan run ntp::provision_gcp
bundle exec rake litmus:install_agent
bundle exec rake litmus:install_module
bundle exec rake ntp:integration
bundle exec rake 'litmus:tear_down'
</code></pre><p>Example
<a href=https://github.com/puppetlabs/puppetlabs-ntp/tree/multinodentp>puppetlabs-ntp</a></p><p><em><strong>Puppet server and multiple agents</strong></em></p><p>A setup where you have Puppet Server and multiple Puppet agents.</p><p>You can use Bolt plans for provisioning multiple nodes, with roles tagged to each of it.</p><p>Puppet has a new <a href=https://github.com/puppetlabs/provision/blob/main/tasks/install_puppetserver.json>task</a> that installs an open source Puppet server in the provision module.</p><p>Commands</p><pre><code>bundle install --path .bundle/gems/ --jobs 4
bundle exec rake spec_prep
bundle exec bolt --modulepath spec/fixtures/modules plan run kubernetes::provision_cluster
bundle exec bolt --modulepath spec/fixtures/modules -i ./spec/fixtures/litmus_inventory.yaml plan run kubernetes::puppetserver_setup
bundle exec rake litmus:install_agent
bundle exec rake litmus:install_module
bundle exec rake kubernetes:integration
bundle exec rake 'litmus:tear_down'
</code></pre><p>Example
<a href=https://github.com/puppetlabs/puppetlabs-kubernetes>puppetlabs-kubernetes</a></p><p><img src=/content-and-tooling-team/assets/2021-05-07-running-multinode-modules-gcp/github_workflow.png alt="Example github workflow run"></p><p><em><strong>PE and agents</strong></em></p><p>A setup where you have a PE server and multiple Puppet agents.</p><p>You can use Bolt plans for provisioning multiple nodes with roles tagged to each of it.</p><p>There is a task to install PE in the <code>puppet-deploy_pe module</code>.
<a href=https://github.com/jarretlavallee/puppet-deploy_pe/tree/master/plans>provision_master/agents</a></p><p>Commands</p><pre><code>bundle install --path .bundle/gems/ --jobs 4
bundle exec rake spec_prep
bundle exec bolt --modulepath spec/fixtures/modules plan run ntp::provision_gcp
bundle exec bolt --modulepath spec/fixtures/modules -i ./spec/fixtures/litmus_inventory.yaml plan run ntp::pe_server
bundle exec bolt --modulepath spec/fixtures/modules -i ./spec/fixtures/litmus_inventory.yaml plan run ntp::pe_agent
bundle exec rake litmus:install_module
bundle exec rake ntp:integration
bundle exec rake 'litmus:tear_down'
</code></pre><p>Example
<a href=https://github.com/puppetlabs/puppetlabs-ntp/tree/multinodentp>puppetlabs-ntp</a></p><p>An example plan that installs a PE server:</p><pre><code>plan ntp::pe_server(
  Optional[String] $version = '2019.8.5',
  Optional[Hash] $pe_settings = {password =&gt; 'puppetlabs'}
) {
  # identify pe server node
  $puppet_server =  get_targets('*').filter |$n| { $n.vars['role'] == 'ntpserver' }

  # install pe server
  run_plan(
    'deploy_pe::provision_master',
    $puppet_server,
    'version' =&gt; $version,
    'pe_settings' =&gt; $pe_settings
  )
}
</code></pre><p>An example plan that installs a Puppet agent:</p><pre><code>plan ntp::pe_agent() {
  # identify pe server and agent nodes
  $puppet_server =  get_targets('*').filter |$n| { $n.vars['role'] == 'ntpserver' }
  $puppet_agent =  get_targets('*').filter |$n| { $n.vars['role'] == 'ntpclient' }

  # install agent
  run_plan(
    'deploy_pe::provision_agent',
    $puppet_agent,
    'master' =&gt; $puppet_server,
  )
}
</code></pre><p>For more GitHub Action workflow examples, see the following:</p><ul><li><a href=https://github.com/puppetlabs/puppetlabs-websphere_application_server/tree/main/.github/workflows>puppetlabs-websphere_application_server</a></li><li><a href=https://github.com/puppetlabs/puppetlabs-kubernetes/tree/main/.github/workflows>puppetlabs-kubernetes</a></li></ul><p>Thanks <a href=https://github.com/tphoney>TP</a> for the valuable work on integration testing.
Thanks <a href=https://github.com/MartyEwings>Marty</a> for the work on installing PE on cloud CI.</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/content-and-tooling-team/blog/posts/2021-01-26-converting-puppetized-dsc-modules/ aria-label="Previous - Converting to use Puppetized DSC Modules" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><a href=/content-and-tooling-team/blog/posts/2021-06-04-pct-early-release/ aria-label="Next - Puppet Content Templates 0.1.0 🚀" class="btn btn-primary">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/puppetize aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://puppetcommunity.slack.com/ aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/puppetlabs/content-and-tooling-team aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 Puppet All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script><script src=/content-and-tooling-team/js/tabpane-persist.js></script><script src=/content-and-tooling-team/js/main.min.20a756bd86e5baf68cf7cef0159a97a60c58d42f04b8b13448fe311997b49fda.js integrity="sha256-IKdWvYbluvaM987wFZqXpgxY1C8EuLE0SP4xGZe0n9o=" crossorigin=anonymous></script></body></html>